<?php

// - http://tcbl.dev.mekit.it/mekit-test

require_once("TcblFeed/FeedFactory.php");
require_once("TcblFeed/FeedItem.php");
require_once("TcblFeed/Plugins/FeedPlugin.php");
require_once("TcblFeed/Plugins/FeedPluginInterface.php");

/**
 *
 * @param array $getFeedOptions
 * @param bool $generateFeeds
 *
 * @returns array
 */
function tcbl_feed_get_renderable_feeds($getFeedOptions = []) {
  $answer = [];

  $feeds = \TcblFeed\FeedFactory::getFeeds($getFeedOptions);

  if (count($feeds)) {
    //$answer['content'] = t('Number of feeds: ' . count($feeds));
    $answer['content'] = [];
    $answer['content']['feeds'] = [];

    /** @var \TcblFeed\FeedItem $feed */
    foreach ($feeds as $feed) {
      $feedThemeItem = [
        '#theme' => 'tcbl_feed_item',
        '#feed_item' => $feed,
      ];
      array_push($answer['content']['feeds'], $feedThemeItem);
    }
  }

  return $answer;
}

/**
 * @param array $generateFeedOptions
 *
 * @todo: implement this with cron hook
 *
 */
function tcbl_feed_generate_feeds($generateFeedOptions = []) {
  try {
    \TcblFeed\FeedFactory::generateFeeds($generateFeedOptions);
  } catch(\ReflectionException $e) {
    //bad stuff :-(
  }
}

/**
 * @param $vars
 */
function tcbl_feed_preprocess_tcbl_feed_item(&$vars) {
  /** @var \TcblFeed\FeedItem $feedItem */
  $feedItem = $vars["feed_item"];

  $vars["theme_hook_suggestions"][] = "tcbl_feed_item_" . $feedItem->getSource();
  $vars["theme_hook_suggestions"][] = "tcbl_feed_item_" . $feedItem->getSource() . '_' . $feedItem->getType();

  $classStub = "feed-item";
  $classes = [];
  $classes[] = $classStub;
  $classes[] = $classStub . "-" . str_replace("_", "-", $feedItem->getSource());
  $classes[] = $classStub . "-" . str_replace("_", "-", $feedItem->getType());
  $vars["classes_array"] = $classes;
}

/**
 * Implements hook_theme().
 */
function tcbl_feed_theme($existing, $type, $theme, $path) {
  return [
    'tcbl_feed_item' => [
      'template' => 'tcbl-feed-item',
      'variables' => [
        'feed_item' => NULL,
        'classes' => NULL,
      ],
      'path' => drupal_get_path('module', 'tcbl_feed') . '/templates',
      /*'pattern' => 'tcbl-feed-item__',*/
    ],
  ];
}

//-----------------------------------------------------------------------------------
//---------------------------------- REMOVED BLOCK INFO -----------------------------
//-----------------------------------------------------------------------------------
/**
 * Implements hook_block_info().
 */
/*
function tcbl_feed_block_info() {
  return [
    'tcbl_feed' => [
      'info' => t("TCBL feed"),
      'cache' => DRUPAL_NO_CACHE,/* DRUPAL_CACHE_GLOBAL* /
    ],
  ];
}
*/

/**
 * Implements hook_block_view().
 *
 * @param string
 *
 * @returns array
 */
/*
function tcbl_feed_block_view($delta = '') {
  $answer = [];

  if ($delta != 'tcbl_feed') {
    return $answer;
  }

  $answer['subject'] = t('TCBL Feeds');
  $answer['content'] = t('No feeds available.');

  $getFeedOptions = [
    "filters" => [],
    "ordering" => "",
  ];
  $answer = tcbl_feed_get_renderable_feeds($getFeedOptions);

  return $answer;
}
*/
